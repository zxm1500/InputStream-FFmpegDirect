name: Build InputStream FFmpegDirect

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt install -y \
          unzip cmake ninja-build g++ make git \
          libfmt-dev libpugixml-dev rapidjson-dev \
          zip curl wget zlib1g-dev \
          libgmp-dev libgmp10 libgmp3-dev \
          libnettle-dev libhogweed-dev \
          pkg-config autoconf automake libtool
        
    - name: Clone Kodi source code
      run: |
        git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git
        
    - name: Clone InputStream FFmpegDirect addon
      run: |
        git clone --depth 1 --branch Omega https://github.com/xbmc/inputstream.ffmpegdirect.git
        
    - name: 预下载依赖或修改配置
      run: |
        echo "=== 处理依赖问题 ==="
        
        # 方法1：尝试预下载 GMP
        cd /tmp
        wget --tries=3 --timeout=30 https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz || \
        wget --tries=3 --timeout=30 https://ftp.gnu.org/gnu/gmp/gmp-6.3.0.tar.xz || \
        echo "GMP 下载失败，将依赖系统库"
        
        # 如果下载成功，放到缓存位置
        if [ -f "gmp-6.3.0.tar.xz" ]; then
          mkdir -p ~/.cache/kodi-build
          mv gmp-6.3.0.tar.xz ~/.cache/kodi-build/
        fi
        
    - name: Build the addon with system libraries
      run: |
        cd inputstream.ffmpegdirect
        
        # 如果可能，修改 CMakeLists.txt 使用系统库
        if [ -f "CMakeLists.txt" ]; then
          echo "尝试修改配置使用系统库..."
          sed -i 's/find_package(GMP REQUIRED)/#find_package(GMP REQUIRED)/' CMakeLists.txt 2>/dev/null || true
          sed -i 's/GMP::gmp/Threads::Threads/' CMakeLists.txt 2>/dev/null || true
        fi
        
        mkdir -p build && cd build
        
        # 尝试不同的配置
        echo "尝试配置 1: 标准配置"
        if ! cmake \
          -DADDONS_TO_BUILD=inputstream.ffmpegdirect \
          -DADDON_SRC_PREFIX=../.. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
          -DPACKAGE_ZIP=1 \
          ../../xbmc/cmake/addons 2>&1 | tee cmake_output.log; then
          
          echo "配置 1 失败，尝试配置 2: 禁用外部下载"
          
          # 清理后重试
          cd ..
          rm -rf build
          mkdir build && cd build
          
          cmake \
            -DADDONS_TO_BUILD=inputstream.ffmpegdirect \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
            -DPACKAGE_ZIP=1 \
            -DDEPENDS_BUILD_GMP=OFF \
            -DDEPENDS_BUILD_EXTERNAL_LIBS=OFF \
            ../../xbmc/cmake/addons 2>&1 | tee cmake_output2.log
        fi
        
        # 编译
        echo "开始编译..."
        make -j$(nproc) VERBOSE=1 2>&1 | tee make_output.log || {
          echo "编译失败，查看日志..."
          tail -50 make_output.log
          exit 1
        }
        
    - name: 检查构建结果
      run: |
        echo "=== 检查构建结果 ==="
        
        # 检查是否生成了 .so 文件
        find inputstream.ffmpegdirect -name "*.so" -type f 2>/dev/null | while read file; do
          echo "找到: $file"
          ls -lh "$file"
        done
        
        # 检查安装目录
        if [ -d "xbmc/addons/inputstream.ffmpegdirect" ]; then
          echo "✅ 安装目录存在"
          ls -la xbmc/addons/inputstream.ffmpegdirect/
        else
          echo "⚠️  安装目录不存在，尝试手动复制"
          
          # 手动复制文件
          mkdir -p xbmc/addons/inputstream.ffmpegdirect
          find inputstream.ffmpegdirect -name "*.so" -type f -exec cp {} xbmc/addons/inputstream.ffmpegdirect/ \;
          
          # 复制其他文件
          if [ -d "inputstream.ffmpegdirect/addon" ]; then
            cp -r inputstream.ffmpegdirect/addon/* xbmc/addons/inputstream.ffmpegdirect/
          fi
        fi
        
    - name: 从安装目录创建 ZIP 包
      run: |
        echo "=== 从安装目录创建 ZIP 包 ==="
        
        if [ ! -d "xbmc/addons/inputstream.ffmpegdirect" ]; then
          echo "❌ 安装目录不存在"
          exit 1
        fi
        
        # 进入安装目录
        cd xbmc/addons/inputstream.ffmpegdirect
        
        # 确保有无版本号的 .so 文件
        if ls *.so.* 2>/dev/null | head -1; then
          VERSIONED_SO=$(ls *.so.* | head -1)
          if [ ! -f "inputstream.ffmpegdirect.so" ]; then
            echo "创建链接: $VERSIONED_SO -> inputstream.ffmpegdirect.so"
            ln -sf "$VERSIONED_SO" inputstream.ffmpegdirect.so
          fi
        fi
        
        # 返回到工作目录并打包
        cd ../../..
        cd xbmc/addons
        zip -r "../../inputstream.ffmpegdirect.zip" inputstream.ffmpegdirect/
        cd ../..
        
        echo "✅ 创建的 ZIP 包:"
        ls -lh inputstream.ffmpegdirect.zip
        
    - name: 上传产物
      uses: actions/upload-artifact@v4
      with:
        name: inputstream-ffmpegdirect-addon
        path: |
          inputstream.ffmpegdirect.zip
        retention-days: 30
